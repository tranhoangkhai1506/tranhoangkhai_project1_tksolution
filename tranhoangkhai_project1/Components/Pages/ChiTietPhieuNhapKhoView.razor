@page "/chitietphieunhapkho-list"
@inject iChiTietPhieuNhapKhoService ChiTietPhieuNhapKhoService

@inject NavigationManager nav
@rendermode @(new InteractiveServerRenderMode(prerender:false))

<PageTitle>CHI TIẾT PHIÊU NHẬP KHO</PageTitle>
<h1>CHI TIẾT PHIÊU NHẬP KHO</h1>
<hr />
<button class="btn btn-primary" @onclick="AddDVT">Thêm chi tiết</button>
@if (itemsQueryable is null)
{
    <hr />
    <p>Chưa tìm thấy chi tiết phiếu nhập kho nào! Vui lòng thêm chi tiết cho phiếu nhập kho!</p>
}
else
{
    <hr />
    <div class="page-size-chooser mb-3">
        Items per page:
        <select class="form-select form-select-sm" style="width: auto; display: inline-block;" @bind="@pagination.ItemsPerPage">
            <option>3</option>
            <option>5</option>
            <option>10</option>
            <option>15</option>
        </select>
    </div>

    <div class="table-responsive">
        <QuickGrid Items="@itemsQueryable" Pagination="@pagination" class="table table-striped table-hover">
            <PropertyColumn Property="@(c => c.Nhap_Kho_ID)" Sortable="true" Title="NHẬP KHO ID" />
            <PropertyColumn Property="@(c => c.San_Pham_ID)" Sortable="true" Title="SẢN PHẨM ID" />
            <PropertyColumn Property="@(c => $"{c.SL_Nhap:0.0}")" Sortable="true" Title="SỐ LƯỢNG" />
            <PropertyColumn Property="@(c => $"{c.Don_Gia_Nhap:0.0}")" Sortable="true" Title="ĐƠN GIÁ" />
            <PropertyColumn Property="@(c => c.SL_Nhap * c.Don_Gia_Nhap)" Format="0.00" Sortable="true" Title="TRỊ GIÁ" />
            <TemplateColumn Title="Actions" Class="text-center">
                <button class="btn btn-info btn-sm me-1" @onclick="@(() => EditCTPNK(context.Nhap_Kho_ID, context.San_Pham_ID))">Hiệu chỉnh</button>
                <button class="btn btn-danger btn-sm me-1" @onclick="@(() => DeleteCTPNK(context.Nhap_Kho_ID, context.San_Pham_ID))">Xóa</button>
            </TemplateColumn>
        </QuickGrid>

    </div>
    @*  <Paginator State="@pagination" /> *@
    <div class="page-buttons d-flex justify-content-around">
        Page:
        @if (pagination.TotalItemCount.HasValue)
        {
            <div class="btn-group">
                @for (var pageIndex = 0; pageIndex <= pagination.LastPageIndex; pageIndex++)
                {
                    var capturedIndex = pageIndex;
                    <button @onclick="@(() => GoToPageAsync(capturedIndex))"
                            class="@PageButtonClass(capturedIndex) btn btn-secondary mx-1"
                            aria-current="@AriaCurrentValue(capturedIndex)"
                            aria-label="Go to page @(pageIndex + 1)">
                        @(pageIndex + 1)
                    </button>
                }
            </div>

        }
    </div>
}

@code {
    PaginationState pagination = new PaginationState { ItemsPerPage = 5 };
    IQueryable<ChiTietPhieuNhapKho>? itemsQueryable;
    protected override async Task OnInitializedAsync()
    {
        itemsQueryable = (await ChiTietPhieuNhapKhoService.GetAllChiTietPhieuNhapKhoAsync()).AsQueryable();
        pagination.TotalItemCountChanged += (sender, eventArgs) => StateHasChanged();
    }

    private async Task GoToPageAsync(int pageIndex)
    {
        await pagination.SetCurrentPageIndexAsync(pageIndex);
    }

    private string? PageButtonClass(int pageIndex)
        => pagination.CurrentPageIndex == pageIndex ? "current" : null;

    private string? AriaCurrentValue(int pageIndex)
        => pagination.CurrentPageIndex == pageIndex ? "page" : null;

    void EditCTPNK(string Nhap_Kho_ID, string San_Pham_ID)
    {
        nav.NavigateTo($"/edit-chitietphieunhapkho/{Nhap_Kho_ID}/{San_Pham_ID}");
    }

    void AddDVT()
    {
        nav.NavigateTo($"/edit-chitietphieunhapkho");
    }
    async Task DeleteCTPNK(string Nhap_Kho_ID, string San_Pham_ID)
    {
        await ChiTietPhieuNhapKhoService.DeleteChiTietPhieuNhapAsync(Nhap_Kho_ID, San_Pham_ID);
        itemsQueryable = (await ChiTietPhieuNhapKhoService.GetAllChiTietPhieuNhapKhoAsync()).AsQueryable();
        pagination.TotalItemCountChanged += (sender, eventArgs) => StateHasChanged();
    }
}
